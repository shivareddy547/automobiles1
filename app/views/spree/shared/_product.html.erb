
<!-- jQuery (CDN) -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ujs/1.2.3/rails.min.js"></script>



<% url = spree.product_path(product, taxon_id: @taxon&.id) %>
<% variant = product.default_variant || product.master %>

<% cache [common_product_cache_keys, product] do %>
  <!-- Image Section -->
  <%= link_to url, class: 'd-block' do %>
    <%= plp_and_carousel_image(product, image_class) %>
  <% end %>

  <!-- Product Name and Price -->
  <div class="product-details">
    <div class="product-component-name" title="<%= product.name %>">
      <%= product.name %>
    </div>
    <div class="product-component-price">
      <%= display_price(product) %>
    </div>
  </div>

  <!-- Options and Stock Row -->
  <table class="table product-options-stock">
    <tbody>
      <tr>
        <% if variant && variant.option_values.present? %>
          <% variant.option_values.each do |option_value| %>
            <td class="option-type">
              <strong><%= option_value.option_type.presentation %>:</strong>
              <%= option_value.presentation %>
            </td>
          <% end %>
        <% end %>
        <td class="product-stock">
          <strong>Stock:</strong>
          <span id="stock-<%= product.id %>"><%= variant.try(:total_on_hand) || 0 %></span>
        </td>
      </tr>
      <tr>
        <td colspan="<%= (variant.option_values.present? ? variant.option_values.size + 1 : 1) %>">
        <!-- Update Stock Button -->
        <button class="btn btn-primary product-action-btn"
                data-product-id="<%= product.id %>"
                data-action="update_stock">
          Update Stock
        </button>
    
        <!-- Buy Now Button -->
        <button class="btn btn-success product-action-btn"
                data-product-id="<%= product.id %>"
                data-action="buy_now">
          Buy Now
        </button>
        </td>
      </tr>
    </tbody>
  </table>
<% end %>




<!-- Bootstrap Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Product Action</h5>
        <button type="button" id="close-action-btn" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="product-info"></p>
        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" class="form-control" min="1" value="1">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancel-action-btn" data-bs-dismiss="modal">Cancel</button>
     

        <button type="button" id="confirm-action-btn" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>
</div>
<script>
$(document).ready(function () {
  $("#cancel-action-btn").on("click", function () {
  $("#productModal").modal("hide");
});

$("#close-action-btn").on("click", function () {
  $("#productModal").modal("hide");
});


  $(".product-action-btn").off("click").on("click", function () {
    let productId = $(this).data("product-id");
    let actionType = $(this).data("action");

    // AJAX Request to Fetch Product Details
    $.ajax({
      url: "/custom/" + productId + "/modal_data",
      type: "GET",
      headers: {
        "X-CSRF-Token": $("meta[name='csrf-token']").attr("content") // Include CSRF token
      },
      data: { action_type: actionType },
      success: function (response) {
        $("#productModalLabel").text(response.title);
        $("#product-info").text("Product: " + response.product_name);
        $("#confirm-action-btn").data("product-id", productId);
        $("#confirm-action-btn").data("action-type", actionType);
        $("#productModal").modal("show");
      },
      error: function (xhr) {
        if (xhr.status === 403) {
          alert("Unauthorized! Please log in as an admin.");
        } else {
          alert("Failed to load product data.");
        }
      }
    });
    
  });

  // Handle Confirm Button Click
  // Handle Confirm Button Click
  // Handle Confirm Button Click
  // Handle Confirm Button Click
  $("#confirm-action-btn").off("click").on("click", function () {
    let productId = $(this).data("product-id");
    let actionType = $(this).data("action-type");
    let quantity = parseInt($("#quantity").val(), 10);
  
    // AJAX Request to Process Action
    $.ajax({
      url: "/custom/" + productId + "/process_product_action",
      type: "POST",
      headers: {
        "X-CSRF-Token": $("meta[name='csrf-token']").attr("content") // Include CSRF token
      },
      data: {
        action_type: actionType,
        quantity: quantity
      },
      success: function (response) {
       
        $("#productModal").modal("hide");
  
        // Update stock count dynamically if the response contains updated stock
        if (response.updated_stock !== undefined) {
          $("#stock-" + response.product_id).text(response.updated_stock);
        }
      },
      error: function (xhr) {
        if (xhr.status === 401) {
          alert("Unauthorized! Please log in as an admin.");
          window.location.href = "/admin/login";
        } else {
          alert("Failed to process request.");
        }
      }
    });
  });
  
  
  
});

</script>