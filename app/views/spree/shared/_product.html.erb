<% url = spree.product_path(product, taxon_id: @taxon&.id) %>
<% variant = product.variants.first || product.master %>

<% cache [common_product_cache_keys, product] do %>
  <!-- Image Section -->
  <%= link_to url, class: 'd-block' do %>
    <%= plp_and_carousel_image(product, "product-component-image d-block img-fluid") %>
  <% end %>

  <!-- Product Name and Price -->
  <div class="product-details">
    <div class="product-component-name" title="<%= product.name %>">
      <%= product.name %>
    </div>
    <div class="product-component-price">
      <%= display_price(product) %>
    </div>
  </div>

  <!-- Options and Stock Row -->
  <div class="product-options-stock">
    <% if variant && variant.option_values.present? %>
      <% variant.option_values.each do |option_value| %>
        <div class="option-type">
          <strong><%= option_value.option_type.presentation %>:</strong>
          <%= option_value.presentation %>
        </div>
      <% end %>
    <% end %>
    <div class="product-stock">
      <strong>Stock:</strong>
      <span id="stock-<%= product.id %>"><%= variant.try(:total_on_hand) || 0 %></span>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="product-action-buttons d-flex flex-column flex-md-row mt-3">
    <button class="btn btn-primary product-action-btn flex-fill me-3"
            data-product-id="<%= product.id %>"
            data-action="update_stock">
      Update Stock
    </button>
    <button class="btn btn-success product-action-btn flex-fill"
            data-product-id="<%= product.id %>"
            data-action="buy_now">
      Buy Now
    </button>
  </div>

<% end %>

<style>

.product-action-buttons .btn{
    margin: 3px;
  }

.product-component-image {
  width: 100%;
  max-width: 250px;
  height: auto;
  object-fit: cover;
}

.product-options-stock {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.option-type, .product-stock {
  flex: 1;
  min-width: 120px;
}

.product-action-buttons {
  display: flex;
  flex-direction: column;
}

@media (min-width: 768px) {
  .product-action-buttons {
    flex-direction: row;
   
  }
  .product-action-buttons .btn{
    margin: 3px;
  }
}

</style>

<script>
$(document).ready(function () {
  $("#cancel-action-btn").on("click", function () {
  $("#productModal").modal("hide");
});

$("#close-action-btn").on("click", function () {
  $("#productModal").modal("hide");
});


  $(".product-action-btn").off("click").on("click", function () {
    let productId = $(this).data("product-id");
    let actionType = $(this).data("action");

    // AJAX Request to Fetch Product Details
    $.ajax({
      url: "/custom/" + productId + "/modal_data",
      type: "GET",
      headers: {
        "X-CSRF-Token": $("meta[name='csrf-token']").attr("content") // Include CSRF token
      },
      data: { action_type: actionType },
      success: function (response) {
        $("#productModalLabel").text(response.title);
        $("#product-info").text("Product: " + response.product_name);
        $("#confirm-action-btn").data("product-id", productId);
        $("#confirm-action-btn").data("action-type", actionType);
        $("#productModal").modal("show");
      },
      error: function (xhr) {
        if (xhr.status === 403) {
          alert("Unauthorized! Please log in as an admin.");
        } else {
          alert("Failed to load product data.");
        }
      }
    });
    
  });

  // Handle Confirm Button Click
  // Handle Confirm Button Click
  // Handle Confirm Button Click
  // Handle Confirm Button Click
  $("#confirm-action-btn").off("click").on("click", function () {
    let productId = $(this).data("product-id");
    let actionType = $(this).data("action-type");
    let quantity = parseInt($("#quantity").val(), 10);
  
    // AJAX Request to Process Action
    $.ajax({
      url: "/custom/" + productId + "/process_product_action",
      type: "POST",
      headers: {
        "X-CSRF-Token": $("meta[name='csrf-token']").attr("content") // Include CSRF token
      },
      data: {
        action_type: actionType,
        quantity: quantity
      },
      success: function (response) {
       
        $("#productModal").modal("hide");
  
        // Update stock count dynamically if the response contains updated stock
        if (response.updated_stock !== undefined) {
          console.log(("#stock-"+response.product_id).length)
          $(".product-stock #stock-" + response.product_id).text(response.updated_stock);

        }
      },
      error: function (xhr) {
        if (xhr.status === 401) {
          alert("Unauthorized! Please log in as an admin.");
          window.location.href = "/admin/login";
        } else {
          alert("Failed to process request.");
        }
      }
    });
  });
  
  
  
});

</script>